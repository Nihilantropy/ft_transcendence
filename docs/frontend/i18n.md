# i18n Implementation Plan - Multiple Language Support

## üéØ Overview & Requirements

### Module Requirement
- **Multiple Language Support (Minor Module)**: Minimum 3 languages
- **Language Switcher**: User-friendly language selection
- **Essential Content Translation**: Navigation, forms, game UI
- **Persistent Selection**: Remember user's language preference
- **Seamless Integration**: No page reloads on language change

### Target Languages
1. **English (en)** - Primary/default language
2. **French (fr)** - Secondary language (42 connection)
3. **Spanish (es)** - Third language (broad accessibility)
4. **Italian (it)** - Fourth language (user location: Rome, Italy)

## üèóÔ∏è i18n System Architecture

### Core i18n Class
```typescript
// src/i18n/i18n.ts

/**
 * @brief Internationalization system for multi-language support
 * 
 * @description Lightweight i18n system without external dependencies.
 * Handles translation loading, caching, and interpolation.
 */
export class I18n {
  private currentLocale: string = 'en'
  private translations: Map<string, Record<string, string>> = new Map()
  private fallbackLocale: string = 'en'
  private listeners: Set<(locale: string) => void> = new Set()

  /**
   * @brief Initialize i18n system
   * @param defaultLocale Default locale to use
   */
  async init(defaultLocale: string = 'en'): Promise<void> {
    this.currentLocale = this.detectUserLocale() || defaultLocale
    await this.loadTranslations(this.currentLocale)
    
    // Load fallback if different from current
    if (this.currentLocale !== this.fallbackLocale) {
      await this.loadTranslations(this.fallbackLocale)
    }
  }

  /**
   * @brief Change current locale
   * @param locale New locale to set
   */
  async setLocale(locale: string): Promise<void> {
    if (locale === this.currentLocale) return

    await this.loadTranslations(locale)
    this.currentLocale = locale
    this.saveUserLocale(locale)
    this.notifyListeners()
  }

  /**
   * @brief Get translated text
   * @param key Translation key
   * @param params Interpolation parameters
   * @return Translated text
   */
  t(key: string, params?: Record<string, string | number>): string {
    const translation = this.getTranslation(key)
    return params ? this.interpolate(translation, params) : translation
  }

  /**
   * @brief Subscribe to locale changes
   * @param listener Callback for locale changes
   * @return Unsubscribe function
   */
  onLocaleChange(listener: (locale: string) => void): () => void {
    this.listeners.add(listener)
    return () => this.listeners.delete(listener)
  }

  private async loadTranslations(locale: string): Promise<void> {
    if (this.translations.has(locale)) return

    try {
      // Dynamic import for code splitting
      const module = await import(`./locales/${locale}.json`)
      this.translations.set(locale, module.default)
    } catch (error) {
      console.warn(`Failed to load translations for locale: ${locale}`)
    }
  }

  private getTranslation(key: string): string {
    const currentTranslations = this.translations.get(this.currentLocale)
    const fallbackTranslations = this.translations.get(this.fallbackLocale)

    return (
      currentTranslations?.[key] ||
      fallbackTranslations?.[key] ||
      `[${key}]` // Show key if no translation found
    )
  }

  private interpolate(text: string, params: Record<string, string | number>): string {
    return text.replace(/\{\{(\w+)\}\}/g, (match, key) => {
      return params[key]?.toString() || match
    })
  }

  private detectUserLocale(): string | null {
    // Check saved preference
    const saved = localStorage.getItem('ft_transcendence_locale')
    if (saved) return saved

    // Check browser language
    const browserLang = navigator.language.split('-')[0]
    const supportedLocales = ['en', 'fr', 'es', 'it']
    
    return supportedLocales.includes(browserLang) ? browserLang : null
  }

  private saveUserLocale(locale: string): void {
    localStorage.setItem('ft_transcendence_locale', locale)
  }

  private notifyListeners(): void {
    this.listeners.forEach(listener => listener(this.currentLocale))
  }

  getCurrentLocale(): string {
    return this.currentLocale
  }

  getSupportedLocales(): string[] {
    return ['en', 'fr', 'es', 'it']
  }
}

// Global instance
export const i18n = new I18n()
```

## üìÅ Translation Files Structure

### Translation File Organization
```
src/i18n/
‚îú‚îÄ‚îÄ locales/
‚îÇ   ‚îú‚îÄ‚îÄ en.json              # English (default)
‚îÇ   ‚îú‚îÄ‚îÄ fr.json              # French
‚îÇ   ‚îú‚îÄ‚îÄ es.json              # Spanish
‚îÇ   ‚îî‚îÄ‚îÄ it.json              # Italian
‚îú‚îÄ‚îÄ types.ts                 # i18n TypeScript types
‚îú‚îÄ‚îÄ i18n.ts                  # Main i18n class
‚îî‚îÄ‚îÄ index.ts                 # Export barrel
```

### Translation Key Structure
```json
// src/i18n/locales/en.json
{
  "app": {
    "title": "ft_transcendence",
    "tagline": "The Ultimate Pong Experience"
  },
  "navigation": {
    "home": "Home",
    "game": "Game",
    "tournament": "Tournament",
    "profile": "Profile",
    "settings": "Settings",
    "logout": "Logout"
  },
  "game": {
    "pong": "Pong",
    "player1": "Player 1",
    "player2": "Player 2",
    "score": "Score",
    "startGame": "Start Game",
    "gameOver": "Game Over",
    "winner": "Winner: {{player}}",
    "waiting": "Waiting for opponent...",
    "controls": {
      "up": "Move Up",
      "down": "Move Down",
      "pause": "Pause Game"
    }
  },
  "tournament": {
    "create": "Create Tournament",
    "join": "Join Tournament",
    "bracket": "Tournament Bracket",
    "participants": "Participants",
    "round": "Round {{number}}",
    "semifinals": "Semifinals",
    "finals": "Finals"
  },
  "auth": {
    "login": "Login",
    "register": "Register",
    "logout": "Logout",
    "username": "Username",
    "email": "Email",
    "password": "Password",
    "confirmPassword": "Confirm Password",
    "forgotPassword": "Forgot Password?",
    "loginWith": "Login with {{provider}}"
  },
  "profile": {
    "stats": "Statistics",
    "friends": "Friends",
    "matches": "Match History",
    "wins": "Wins",
    "losses": "Losses",
    "winRate": "Win Rate",
    "addFriend": "Add Friend",
    "online": "Online",
    "offline": "Offline"
  },
  "chat": {
    "messages": "Messages",
    "sendMessage": "Send Message",
    "typeMessage": "Type a message...",
    "inviteToGame": "Invite to Game",
    "blockUser": "Block User",
    "unblockUser": "Unblock User"
  },
  "settings": {
    "language": "Language",
    "theme": "Theme",
    "notifications": "Notifications",
    "privacy": "Privacy",
    "account": "Account",
    "deleteAccount": "Delete Account",
    "saveChanges": "Save Changes"
  },
  "common": {
    "loading": "Loading...",
    "error": "Error",
    "success": "Success",
    "cancel": "Cancel",
    "confirm": "Confirm",
    "save": "Save",
    "delete": "Delete",
    "edit": "Edit",
    "close": "Close",
    "back": "Back",
    "next": "Next",
    "previous": "Previous",
    "search": "Search",
    "filter": "Filter",
    "sort": "Sort"
  },
  "errors": {
    "networkError": "Network error. Please try again.",
    "authRequired": "Authentication required.",
    "invalidCredentials": "Invalid credentials.",
    "userNotFound": "User not found.",
    "gameNotFound": "Game not found.",
    "serverError": "Server error. Please try again later."
  }
}
```

### French Translation Example
```json
// src/i18n/locales/fr.json
{
  "app": {
    "title": "ft_transcendance",
    "tagline": "L'Exp√©rience Pong Ultime"
  },
  "navigation": {
    "home": "Accueil",
    "game": "Jeu",
    "tournament": "Tournoi",
    "profile": "Profil",
    "settings": "Param√®tres",
    "logout": "D√©connexion"
  },
  "game": {
    "pong": "Pong",
    "player1": "Joueur 1",
    "player2": "Joueur 2",
    "score": "Score",
    "startGame": "Commencer le Jeu",
    "gameOver": "Jeu Termin√©",
    "winner": "Gagnant: {{player}}",
    "waiting": "En attente d'un adversaire...",
    "controls": {
      "up": "Monter",
      "down": "Descendre",
      "pause": "Pause"
    }
  }
  // ... rest of translations
}
```

## üîß Integration with Components

### i18n Component Mixin
```typescript
// src/components/base/I18nComponent.ts

/**
 * @brief Component mixin for i18n support
 * 
 * @description Extends base component with translation capabilities
 * and automatic re-rendering on locale changes.
 */
export class I18nComponent<TProps = {}, TState = {}> extends Component<TProps, TState> {
  private unsubscribeLocale?: () => void

  constructor(props: TProps, initialState: TState) {
    super(props, initialState)
    
    // Subscribe to locale changes
    this.unsubscribeLocale = i18n.onLocaleChange(() => {
      this.rerender()
    })
  }

  /**
   * @brief Get translated text
   * @param key Translation key
   * @param params Interpolation parameters
   * @return Translated text
   */
  protected t(key: string, params?: Record<string, string | number>): string {
    return i18n.t(key, params)
  }

  /**
   * @brief Get current locale
   * @return Current locale string
   */
  protected getCurrentLocale(): string {
    return i18n.getCurrentLocale()
  }

  protected beforeUnmount(): void {
    super.beforeUnmount()
    this.unsubscribeLocale?.()
  }
}
```

### Language Switcher Component
```typescript
// src/components/ui/LanguageSwitcher.ts

export interface LanguageSwitcherProps {
  variant?: 'dropdown' | 'buttons'
  showFlags?: boolean
}

export class LanguageSwitcher extends I18nComponent<LanguageSwitcherProps> {
  private languages = [
    { code: 'en', name: 'English', flag: 'üá∫üá∏' },
    { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑' },
    { code: 'es', name: 'Espa√±ol', flag: 'üá™üá∏' },
    { code: 'it', name: 'Italiano', flag: 'üáÆüáπ' }
  ]

  render(): string {
    const currentLocale = this.getCurrentLocale()
    const variant = this.props.variant || 'dropdown'
    const showFlags = this.props.showFlags ?? true

    if (variant === 'buttons') {
      return this.renderButtons(currentLocale, showFlags)
    }

    return this.renderDropdown(currentLocale, showFlags)
  }

  private renderDropdown(currentLocale: string, showFlags: boolean): string {
    const currentLang = this.languages.find(lang => lang.code === currentLocale)
    const options = this.languages
      .map(lang => `
        <option value="${lang.code}" ${lang.code === currentLocale ? 'selected' : ''}>
          ${showFlags ? lang.flag + ' ' : ''}${lang.name}
        </option>
      `).join('')

    return `
      <div class="language-switcher">
        <label class="label-base" for="language-select">
          ${this.t('settings.language')}
        </label>
        <select 
          id="language-select"
          class="input-base"
          data-action="changeLanguage"
        >
          ${options}
        </select>
      </div>
    `
  }

  private renderButtons(currentLocale: string, showFlags: boolean): string {
    const buttons = this.languages
      .map(lang => `
        <button
          type="button"
          class="btn-base ${lang.code === currentLocale ? 'btn-primary' : 'btn-secondary'}"
          data-action="changeLanguage"
          data-locale="${lang.code}"
          title="${lang.name}"
        >
          ${showFlags ? lang.flag : lang.code.toUpperCase()}
        </button>
      `).join('')

    return `
      <div class="language-switcher language-switcher--buttons">
        <div class="flex gap-2">
          ${buttons}
        </div>
      </div>
    `
  }

  protected afterMount(): void {
    this.element?.addEventListener('change', this.handleLanguageChange)
    this.element?.addEventListener('click', this.handleLanguageClick)
  }

  protected beforeUnmount(): void {
    super.beforeUnmount()
    this.element?.removeEventListener('change', this.handleLanguageChange)
    this.element?.removeEventListener('click', this.handleLanguageClick)
  }

  private handleLanguageChange = (event: Event) => {
    const select = event.target as HTMLSelectElement
    if (select.dataset.action === 'changeLanguage') {
      i18n.setLocale(select.value)
    }
  }

  private handleLanguageClick = (event: Event) => {
    const button = event.target as HTMLButtonElement
    if (button.dataset.action === 'changeLanguage' && button.dataset.locale) {
      i18n.setLocale(button.dataset.locale)
    }
  }
}
```

## üì± Responsive Language UI

### Mobile-Friendly Language Selector
```css
/* Responsive language switcher styles */
.language-switcher {
  @apply relative;
}

.language-switcher--buttons {
  @apply 
    /* Mobile: Compact flag buttons */
    flex md:hidden
}

.language-switcher--dropdown {
  @apply 
    /* Desktop: Full dropdown */
    hidden md:block
}

/* Mobile optimization */
@media (max-width: 640px) {
  .language-switcher--buttons button {
    @apply text-xs px-2 py-1;
  }
}
```

## üîÑ Real-time Content Updates

### Translation Update System
```typescript
// src/services/TranslationService.ts

/**
 * @brief Service for managing dynamic translation updates
 */
export class TranslationService {
  /**
   * @brief Update page title based on current route
   * @param routeKey Route translation key
   */
  updatePageTitle(routeKey: string): void {
    const title = i18n.t(`pages.${routeKey}.title`)
    const appName = i18n.t('app.title')
    document.title = `${title} - ${appName}`
  }

  /**
   * @brief Update HTML lang attribute
   * @param locale Current locale
   */
  updateHtmlLang(locale: string): void {
    document.documentElement.lang = locale
  }

  /**
   * @brief Update text direction for RTL languages
   * @param locale Current locale
   */
  updateTextDirection(locale: string): void {
    const rtlLanguages = ['ar', 'he', 'fa'] // Future RTL support
    const direction = rtlLanguages.includes(locale) ? 'rtl' : 'ltr'
    document.documentElement.dir = direction
  }
}
```

## üß™ i18n Testing Strategy

### Translation Testing
```typescript
// src/__tests__/i18n/i18n.test.ts

describe('I18n System', () => {
  beforeEach(() => {
    // Reset i18n state
    localStorage.clear()
  })

  test('should load default locale', async () => {
    await i18n.init('en')
    expect(i18n.getCurrentLocale()).toBe('en')
  })

  test('should translate simple keys', () => {
    const translated = i18n.t('common.loading')
    expect(translated).toBe('Loading...')
  })

  test('should interpolate parameters', () => {
    const translated = i18n.t('game.winner', { player: 'Alice' })
    expect(translated).toBe('Winner: Alice')
  })

  test('should fall back to key if translation missing', () => {
    const translated = i18n.t('missing.key')
    expect(translated).toBe('[missing.key]')
  })

  test('should persist language selection', async () => {
    await i18n.setLocale('fr')
    expect(localStorage.getItem('ft_transcendence_locale')).toBe('fr')
  })
})
```

### Component Translation Testing
```typescript
// src/__tests__/components/LanguageSwitcher.test.ts

describe('LanguageSwitcher', () => {
  test('should render all supported languages', () => {
    const { container } = renderComponent(LanguageSwitcher, {})
    const options = container.querySelectorAll('option')
    expect(options).toHaveLength(4) // en, fr, es, it
  })

  test('should change language on selection', async () => {
    const { container } = renderComponent(LanguageSwitcher, {})
    const select = container.querySelector('select') as HTMLSelectElement
    
    select.value = 'fr'
    select.dispatchEvent(new Event('change'))
    
    expect(i18n.getCurrentLocale()).toBe('fr')
  })
})
```

## üöÄ Implementation Phases

### Phase 1: Core i18n System (Day 1)
- [ ] Implement base I18n class
- [ ] Create translation file structure
- [ ] Set up locale detection and persistence
- [ ] Basic interpolation support

### Phase 2: Component Integration (Day 1-2)
- [ ] Create I18nComponent base class
- [ ] Implement LanguageSwitcher component
- [ ] Update existing components to use translations
- [ ] Add automatic re-rendering on locale changes

### Phase 3: Content Translation (Day 2-3)
- [ ] Translate all navigation elements
- [ ] Translate game UI text
- [ ] Translate form labels and buttons
- [ ] Translate error messages

### Phase 4: Additional Languages (Day 3)
- [ ] Complete French translations
- [ ] Complete Spanish translations
- [ ] Complete Italian translations
- [ ] Test all language combinations

### Phase 5: Polish & Testing (Day 3)
- [ ] Add loading states for translation loading
- [ ] Implement translation caching
- [ ] Comprehensive testing
- [ ] Performance optimization

## üìà Performance Considerations

### Optimization Strategies
- **Lazy Loading**: Load translations only when needed
- **Caching**: Cache loaded translations in memory
- **Code Splitting**: Separate translation bundles per language
- **Compression**: Minimize translation file sizes
- **Fallback Strategy**: Graceful degradation for missing translations

### Bundle Size Management
```typescript
// Dynamic imports for better code splitting
const loadTranslations = async (locale: string) => {
  const { default: translations } = await import(
    /* webpackChunkName: "locale-[request]" */
    `./locales/${locale}.json`
  )
  return translations
}
```